{{ $comments := readDir "data/comments" }}
{{ $.Scratch.Add "hasComments" 0 }}
{{ $slug := substr .Params.url 12 -1}}
{{ $semiSlug := substr .Params.url 9 -1}}
{{ $.Scratch.Set "realSlug" $slug }}
{{ $postDate := .Date.Format "2006" }}

{{ if ge $postDate "2018" }}
    {{ .Scratch.Set "realSlug" $semiSlug }}
{{ end }}

<h4 class="ttu tracked">Comments:</h4>

<form class="bb pv4 ph2 black-80 justify-around-ns w-100" method="POST" action="https://api.staticman.net/v2/entry/Doocey/tyne-time-hugo/master/comments" netlify-honeypot="bot-field">
  <input type="hidden" name="options[redirect]" value="{{ .Permalink }}#comment-submitted">
  <input type="hidden" name="options[entryId]" value="{{ .UniqueID }}">
  <input type="hidden" name="options[urlSlug]" value="{{ $.Scratch.Get "realSlug" }}">

  <div class="flex">
      <div class="w-100 w-50-ns">
        <label for="name" class="f6 b db mb2">Name:</label>
        <input name="fields[name]" type="text" class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="name-desc" required>
      </div>
      <div class="ph3 w-100 w-50-ns">
        <label for="name" class="f6 b db mb2">Email:</label>
        <input name="fields[email]" type="email" class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="email-address" required>
    </div>
  </div>
  <div class="w-100 w-100-ns">
      <label for="comment" class="f6 b db mb2">Comment:</span></label>
      <textarea name="fields[message]" class="db border-box hover-black w-100  ba b--black-20 pa2 br2 mb2" aria-describedby="comment-desc" placeholder="Use common sense in all comments, please..." required></textarea>
  </div>
  <input type="submit" class="georgia ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6 dib" value="Submit Comment">
</form>

  {{ range $comments }}
    {{ if eq .Name ($.Scratch.Get "realSlug") }}
      {{ $.Scratch.Add "hasComments" 1 }}
      {{ range $index, $comments := (index $.Site.Data.comments ($.Scratch.Get "realSlug") ) }}
      <article class="flex lh-copy pa3 ba b--black-20 flex-wrap justify-around-ns bg-light-gray mt2">
        <div class="w-100 w-10-l pa1 tc">
          <img class="br-100 w3 h3" src="https://www.gravatar.com/avatar/{{ .email }}?s=70&d=mm" />
          <span class="f7 db black-90 underline">{{ .name }}:</span>
          <small>‚è± {{ dateFormat "02/01/2006" .date }}</small>
        </div>
        <div class="w-100 w-60-l pv2">
            <p class="f5-ns f6 db black-70 mv1">{{ .message }}</p>
        </div>
      </article>
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if eq ($.Scratch.Get "hasComments") 0 }}
    <p>Nothing yet.</p>
  {{ end }}
</section>
